<!DOCTYPE html>
<html lang="tr">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Hisse Portföyüm - Firebase</title>
    <style>
        body {
            font-family: Arial, sans-serif;
            margin: 0;
            padding: 0;
            background-color: #ffffff;
            padding-bottom: 80px;
        }

        /* Üst Başlık */
        .header {
            background-color: #eaeaea;
            display: flex;
            align-items: center;
            padding: 10px;
            border-bottom: 1px solid #eee;
        }
        .header h1 {
            flex: 1;
            text-align: center;
            font-size: 20px;
            margin: 0;
            font-weight: bold;
            cursor: pointer;
            user-select: none;
        }
        .back-icon { font-size: 20px; cursor: pointer; padding: 5px; }

        /* Kullanıcı Bilgisi ve Giriş */
        .auth-bar {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 5px 15px;
            background: #f9f9f9;
            font-size: 12px;
            border-bottom: 1px solid #eee;
        }
        .btn-google {
            background: #fff;
            border: 1px solid #ddd;
            padding: 5px 10px;
            border-radius: 4px;
            cursor: pointer;
            font-size: 11px;
            display: flex;
            align-items: center;
            gap: 5px;
        }

        /* Izgara Yapısı (Grid Layout) */
        .grid-layout {
            display: grid;
            grid-template-columns: 1fr 1fr 1fr 1.2fr 1fr;
            align-items: center;
        }

        /* Sütun Başlıkları */
        .table-header {
            font-size: 13px;
            color: #666;
            border-bottom: 1px solid #eee;
        }
        .table-header div { text-align: right; }
        
        .table-header .col-settings { 
            text-align: center; 
            color: #5b7199; 
            display: flex;
            justify-content: center;
            align-items: center;
            border: 1px solid #f3f3f3;
            height: 45px;
            cursor: pointer;
        }
        .table-header .col-symbol { text-align: left; padding-left: 10px; }

        /* Hisse Satırları */
        .portfolio-row {
            border-bottom: 1px solid #eee;
            padding: 10px 0;
        }
        .main-data { font-size: 15px; }
        .col-symbol { font-weight: normal; text-align: left; padding-left: 10px; text-transform: uppercase; }
        .col-val { text-align: right; padding-right: 5px; }
        .col-kz {
            text-align: right;
            padding-right: 5px;
            display: flex;
            justify-content: flex-end;
            align-items: center;
        }
        .red { color: #d9534f; font-weight: bold; }
        .green { color: #5cb85c; font-weight: bold; }

        /* Toplam Satırı */
        .total-row {
            padding: 12px 0;
            font-weight: bold;
            font-size: 15px;
            border-top: 2px solid #eee;
            background-color: #fff;
        }
        .total-label { grid-column: 1 / 4; text-align: left; padding-left: 10px; }
        .total-value { text-align: right; padding-right: 5px; }

        /* Gizlenebilir Admin Paneli */
        #adminPanel {
            display: none;
            background: #f4f4f4;
            padding: 15px;
            border-bottom: 2px solid #ddd;
        }

        .form-row { display: flex; gap: 5px; margin-bottom: 8px; align-items: center; }
        .form-row label { width: 80px; font-size: 12px; font-weight: bold; }
        input, select { flex: 1; padding: 8px; border: 1px solid #ccc; border-radius: 4px; font-size: 12px; }
        
        .btn-group { display: flex; gap: 5px; margin-top: 10px; }
        button { border: none; border-radius: 4px; cursor: pointer; font-weight: bold; padding: 10px; }
        
        .btn-add { background-color: #2c3e50; color: white; }
        .btn-upd { background-color: #2980b9; color: white; }
        .btn-del { background-color: #c0392b; color: white; }
        .btn-sync { background-color: #27ae60; color: white; width: 100%; margin-bottom: 10px; }
        .btn-reset { background-color: #7f8c8d; width: 100%; margin-top: 15px; font-size: 11px; opacity: 0.8; color: white; }

        /* Alt Navigasyon */
        .bottom-nav {
            position: fixed;
            bottom: 0;
            width: 100%;
            display: flex;
            justify-content: space-around;
            background: #eaeaea;
            padding: 8px 0;
            border-top: 1px solid #eee;
            font-size: 12px;
            color: #888;
            z-index: 100;
        }
        .nav-item { text-align: center; }
        .active-nav { color: #000; }

        #loadingStatus {
            position: fixed;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            background: rgba(0,0,0,0.8);
            color: white;
            padding: 20px;
            border-radius: 10px;
            display: none;
            z-index: 9999;
        }
    </style>
</head>
<body>

    <div id="loadingStatus">Senkronize ediliyor...</div>

    <div class="header">
        <div class="back-icon" onclick="history.back()">
            <svg width="25" height="25" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
              <line x1="15" y1="12" x2="5" y2="12" />
              <path d="M10 6 L4 12 L10 18" />
            </svg>
        </div>
       <h1 onclick="toggleAdminPanel()">Hisse Portföyüm</h1>
    </div>

    

    <div class="table-header grid-layout">
        <div class="col-settings" onclick="toggleAdminPanel()">
<svg width="24" height="24" viewBox="0 0 24 24"
     xmlns="http://www.w3.org/2000/svg">

  <defs>
    <!-- diş -->
    <path id="tooth" d="
      M 30 10
      L 90 10
      L 120 130
      L 90 250
      L 30 250
      L 0 130
      Z
    "/>
    <path id="tooth2" d="
      M 40 10
      L 80 10
      L 110 130
      L 80 250
      L 40 250
      L 10 130
      Z
    "/>

    <!-- 6gen gövde -->
<path id="hex" d="
  M 60 22
  L 153.6 76
  L 153.6 184
  L 60 238
  L -33.6 184
  L -33.6 76
  Z
"/>



    <!-- merkez delik maskesi -->
    <mask id="hole">
      <rect x="-300" y="-300" width="600" height="600" fill="white"/>
      <circle cx="60" cy="130" r="22" fill="black"/>
    </mask>
     <mask id="hole2">
      <rect x="-300" y="-300" width="700" height="700" fill="white"/>
      <circle cx="60" cy="130" r="50" fill="black"/>
    </mask>
  </defs>

  <!-- ===================== -->
  <!-- ALT: SİYAH (24x24) -->
  <!-- ===================== -->
  <g transform="translate(12 12) scale(0.1) translate(-60 -130)"
     fill="currentColor" stroke="none" mask="url(#hole)">

    <use href="#hex"/>
    <use href="#tooth"/>
    <use href="#tooth" transform="rotate(60 60 130)"/>
    <use href="#tooth" transform="rotate(120 60 130)"/>
    <use href="#tooth" transform="rotate(180 60 130)"/>
    <use href="#tooth" transform="rotate(240 60 130)"/>
    <use href="#tooth" transform="rotate(300 60 130)"/>
  </g>

  <!-- ===================== -->
  <!-- ÜST: BEYAZ (20x20) -->
  <!-- ===================== -->
  <!-- 20 / 24 = 0.8333 -->
  <g transform="
       translate(12 12)
       scale(0.1)
       scale(0.8333)
       translate(-60 -130)
     "
     fill="white" stroke="none" mask="url(#hole2)">

    <use href="#hex"/>
    <use href="#tooth2"/>
    <use href="#tooth2" transform="rotate(60 60 130)"/>
    <use href="#tooth2" transform="rotate(120 60 130)"/>
    <use href="#tooth2" transform="rotate(180 60 130)"/>
    <use href="#tooth2" transform="rotate(240 60 130)"/>
    <use href="#tooth2" transform="rotate(300 60 130)"/>
  </g>

</svg>







        </div>
        <div>Maliyet</div>
        <div>Miktar</div>
        <div>K/Z</div>
        <div>Kapanış</div>
    </div>

    <div id="hisseTableBody"></div>

    <div class="total-row grid-layout">
        <div class="total-label">Toplam</div>
        <div id="totalProfit" class="total-value red">0,00</div>
    </div>

    <div id="adminPanel">
    <div class="auth-bar">
        <span id="userEmail">Giriş Yapılmadı</span>
        <button id="authBtn" class="btn-google">Google Giriş</button>
    </div>
        <button class="btn-sync" onclick="guncelFiyatlariGetir()">Mynet'ten Fiyatları Güncelle</button>
         
        <div class="form-container">
            <div class="form-row">
                <label>Hisse Adı:</label>
                <input type="text" id="hisseAd">
            </div>
            <div class="form-row">
                <label>Maliyet:</label>
                <input type="number" id="maliyet" step="0.01">
            </div>
            <div class="form-row">
                <label>Adet:</label>
                <input type="number" id="adet">
            </div>
            <div class="form-row">
                <label>Fiyat:</label>
                <input type="number" id="fiyat" step="0.01">
            </div>

            <select id="hisseSelect" onchange="hisseSec()">
                <option value="">Bir hisse seçin</option>
            </select>
            
            <div class="btn-group">
                <button class="btn-add" onclick="ekleHisse()">Ekle</button>
                <button class="btn-upd" onclick="guncelleHisse()">Güncelle</button>
                <button class="btn-del" onclick="silHisse()">Sil</button>
            </div>
        </div>    
        <button class="btn-reset" onclick="verileriSifirla()">Verileri Sıfırla</button>
    </div>    


    <div class="bottom-nav">
        <div class="nav-item"><svg width="25" height="25" viewBox="0 0 24 24" fill="currentColor" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
  <line x1="8" y1="6" x2="21" y2="6"></line>
  <line x1="8" y1="12" x2="21" y2="12"></line>
  <line x1="8" y1="18" x2="21" y2="18"></line>
  <line x1="3" y1="6" x2="3.3" y2="6.3"></line>
  <line x1="3" y1="12" x2="3.3" y2="12.3"></line>
  <line x1="3" y1="18" x2="3.3" y2="18.3"></line>
  <line x1="3.3" y1="6" x2="3" y2="6.3"></line>
  <line x1="3.3" y1="12" x2="3" y2="12.3"></line>
  <line x1="3.3" y1="18" x2="3" y2="18.3"></line>
</svg><br>Ekranım</div>
        <div class="nav-item"><svg width="25" height="25" viewBox="0 0 28 28" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
  <polyline points="21 14 18 14 16 9 12 23 9 0 6 14 2 14"></polyline><circle cx="23" cy="14" r="2" fill="none"></circle>

</svg><br>Piyasalar</div>
        <div class="nav-item"><svg width="25" height="25" viewBox="0 0 24 24" fill="none">
  <path d="M17 6H21V18C21 19.6569 19.6569 21 18 21H17" 
        stroke="#777" stroke-width="1.5" stroke-linecap="round" stroke-linejoin="round" />

  <polyline points="3,3 17,3 17,19 18,21 3,21 3,2.35" 
            stroke="#777" 
            fill="none" 
            stroke-width="1.5" stroke-linejoin="round"/>

  <rect x="5" y="6" width="4" height="4" rx="0.5" fill="#777"/>

  <line x1="10.5" y1="7" x2="14" y2="7" stroke="#777" stroke-width="1.5" stroke-linecap="round"/>
  <line x1="10.5" y1="9.5" x2="14" y2="9.5" stroke="#777" stroke-width="1.5" stroke-linecap="round"/>
  <line x1="5.5" y1="12" x2="14" y2="12" stroke="#777" stroke-width="1.5" stroke-linecap="round"/>
  <line x1="5.5" y1="14.5" x2="14" y2="14.5" stroke="#777" stroke-width="1.5" stroke-linecap="round"/>
  <line x1="5.5" y1="17" x2="14" y2="17" stroke="#777" stroke-width="1.5" stroke-linecap="round"/>
</svg>
<br>Haberler</div>
        <div class="nav-item active-nav"><svg width="25" height="25" viewBox="0 0 24 24" fill="none" xmlns="http://www.w3.org/2000/svg">
  <path d="M17 7V5C17 3.89543 16.1046 3 15 3H9C7.89543 3 7 3.89543 7 5V7H4C2.89543 7 2 7.89543 2 9V11H22V9C22 7.89543 21.1046 7 20 7H17ZM9 5H15V7H9V5Z" fill="currentColor"/>
  
  <path d="M2 12V18C2 19.1046 2.89543 20 4 20H20C21.1046 20 22 19.1046 22 18V12H15V13H9V12H2Z" fill="currentColor"/>
</svg><br>Portföyüm</div>
    </div>


    <!-- Firebase SDK'ları -->
    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-app.js";
        import { getAuth, signInWithPopup, GoogleAuthProvider, onAuthStateChanged, signOut, signInAnonymously, signInWithCustomToken } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-auth.js";
        import { getFirestore, doc, setDoc, getDoc, collection, onSnapshot, deleteDoc, updateDoc, writeBatch } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-firestore.js";

        // Senin paylaştığın Firebase Config
        const firebaseConfig = {
            apiKey: "AIzaSyB0YfbsNuiFWyXc0W3jGIuZxmfIs7dkOH8",
            authDomain: "cloneportfoy.firebaseapp.com",
            projectId: "cloneportfoy",
            storageBucket: "cloneportfoy.firebasestorage.app",
            messagingSenderId: "859524969826",
            appId: "1:859524969826:web:da786a34c22bcbcc8de83b",
            measurementId: "G-SXZKQX187N"
        };

        const app = initializeApp(firebaseConfig);
        const auth = getAuth(app);
        const db = getFirestore(app);
        const appId = typeof __app_id !== 'undefined' ? __app_id : 'default-portfoy';

        let hisseler = [];
        let currentUser = null;

        // Sayfa Elemanları
        const authBtn = document.getElementById('authBtn');
        const userEmailSpan = document.getElementById('userEmail');
        const loadingStatus = document.getElementById('loadingStatus');

        // Giriş Durumu Takibi
        onAuthStateChanged(auth, async (user) => {
            currentUser = user;
            if (user) {
                userEmailSpan.textContent = user.displayName || user.email;
                authBtn.textContent = "Çıkış Yap";
                subscribeToData();
            } else {
                userEmailSpan.textContent = "Giriş Yapılmadı";
                authBtn.textContent = "Google Giriş";
                // Eğer token varsa otomatik gir, yoksa anonim dene (Opsiyonel)
                try {
                    if (typeof __initial_auth_token !== 'undefined' && __initial_auth_token) {
                        await signInWithCustomToken(auth, __initial_auth_token);
                    } else {
                        // signInAnonymously(auth); // Otomatik anonim giriş istersen açabilirsin
                    }
                } catch(e) {}
            }
        });

        // Google Giriş / Çıkış Butonu
        authBtn.onclick = async () => {
            if (currentUser) {
                await signOut(auth);
                window.location.reload();
            } else {
                const provider = new GoogleAuthProvider();
                try {
                    await signInWithPopup(auth, provider);
                } catch (e) {
                    console.error("Giriş hatası:", e);
                }
            }
        };

        // Firestore'dan Canlı Veri Dinleme
        function subscribeToData() {
            if (!currentUser) return;
            // RULE 1: /artifacts/{appId}/users/{userId}/{collectionName}
            const colRef = collection(db, 'artifacts', appId, 'users', currentUser.uid, 'hisseler');
            
            onSnapshot(colRef, (snapshot) => {
                hisseler = snapshot.docs.map(doc => ({ id: doc.id, ...doc.data() }));
                tabloyuGuncelle();
                hisseListesiniGuncelle();
            }, (error) => {
                console.error("Veri dinleme hatası:", error);
            });
        }

        // --- CRUD İşlemleri ---

        window.ekleHisse = async () => {
            if (!currentUser) return alert("Lütfen önce giriş yapın.");
            const data = getFormVerileri();
            if (!data.ad) return alert("Hisse adı gerekli.");

            loadingStatus.style.display = "block";
            const docRef = doc(db, 'artifacts', appId, 'users', currentUser.uid, 'hisseler', data.ad);
            await setDoc(docRef, data);
            loadingStatus.style.display = "none";
            formuTemizle();
        };

        window.guncelleHisse = async () => {
            if (!currentUser) return;
            const data = getFormVerileri();
            const seciliHisseAd = document.getElementById("hisseSelect").value;
            if (!seciliHisseAd) return alert("Güncellemek için bir hisse seçin.");

            loadingStatus.style.display = "block";
            const docRef = doc(db, 'artifacts', appId, 'users', currentUser.uid, 'hisseler', seciliHisseAd);
            await updateDoc(docRef, data);
            loadingStatus.style.display = "none";
        };

        window.silHisse = async () => {
            const seciliHisseAd = document.getElementById("hisseSelect").value;
            if (!seciliHisseAd || !currentUser) return alert("Silmek için bir hisse seçin.");

            if(confirm(`${seciliHisseAd} silinecek, emin misiniz?`)) {
                loadingStatus.style.display = "block";
                await deleteDoc(doc(db, 'artifacts', appId, 'users', currentUser.uid, 'hisseler', seciliHisseAd));
                loadingStatus.style.display = "none";
                formuTemizle();
            }
        };

        window.verileriSifirla = async () => {
            if (!currentUser) return;
            if(confirm("Tüm portföyünüz silinecek. Emin misiniz?")) {
                loadingStatus.style.display = "block";
                // Firestore'da toplu silme (RULE 2: Query ile çekip tek tek veya batch sil)
                for (let h of hisseler) {
                    await deleteDoc(doc(db, 'artifacts', appId, 'users', currentUser.uid, 'hisseler', h.ad));
                }
                loadingStatus.style.display = "none";
            }
        };

        // --- UI & Yardımcı Fonksiyonlar ---

        function getFormVerileri() {
            return {
                ad: document.getElementById("hisseAd").value.toUpperCase().trim(),
                maliyet: parseFloat(document.getElementById("maliyet").value) || 0,
                adet: parseInt(document.getElementById("adet").value) || 0,
                fiyat: parseFloat(document.getElementById("fiyat").value) || 0,
                updatedAt: Date.now()
            };
        }

        window.hisseSec = () => {
            const seciliHisseAd = document.getElementById("hisseSelect").value;
            const hisse = hisseler.find(h => h.ad === seciliHisseAd);
            if (hisse) {
                document.getElementById("hisseAd").value = hisse.ad;
                document.getElementById("maliyet").value = hisse.maliyet;
                document.getElementById("adet").value = hisse.adet;
                document.getElementById("fiyat").value = hisse.fiyat;
            } else {
                formuTemizle();
            }
        };

        function tabloyuGuncelle() {
            const tableBody = document.getElementById("hisseTableBody");
            tableBody.innerHTML = "";
            let toplamKZ = 0;
            const trLocale = { minimumFractionDigits: 2, maximumFractionDigits: 2 };

            hisseler.forEach((hisse) => {
                const karZarar = (hisse.fiyat - hisse.maliyet) * hisse.adet;
                toplamKZ += karZarar;
                
                const row = document.createElement("div");
                row.className = "portfolio-row";
                const renk = karZarar < 0 ? "red" : "green";
                
                row.innerHTML = `
                    <div class="main-data grid-layout">
                        <div class="col-symbol">${hisse.ad}</div>
                        <div class="col-val">${hisse.maliyet.toFixed(2)}</div>
                        <div class="col-val">${hisse.adet}</div>
                        <div class="col-kz ${renk}">${karZarar.toLocaleString('tr-TR', trLocale)}</div>
                        <div class="col-val">${hisse.fiyat.toFixed(2)}</div>
                    </div>
                `;
                tableBody.appendChild(row);
            });

            const totalEl = document.getElementById("totalProfit");
            totalEl.textContent = toplamKZ.toLocaleString('tr-TR', trLocale);
            totalEl.className = `total-value ${toplamKZ < 0 ? "red" : "green"}`;
        }

        function hisseListesiniGuncelle() {
            const select = document.getElementById("hisseSelect");
            select.innerHTML = '<option value="">Bir hisse seçin</option>';
            hisseler.forEach(h => {
                const opt = document.createElement("option");
                opt.value = h.ad;
                opt.textContent = h.ad;
                select.appendChild(opt);
            });
        }

        function formuTemizle() {
            document.getElementById("hisseAd").value = "";
            document.getElementById("maliyet").value = "";
            document.getElementById("adet").value = "";
            document.getElementById("fiyat").value = "";
            document.getElementById("hisseSelect").value = "";
        }

        window.toggleAdminPanel = () => {
            const p = document.getElementById("adminPanel");
            p.style.display = p.style.display === "block" ? "none" : "block";
        };

        // Mynet Fiyat Çekme (Proxy/CORS kısıtlaması nedeniyle direkt tarayıcıdan zor olabilir ama mantığı koruduk)
        window.guncelFiyatlariGetir = async () => {
            if (!currentUser || hisseler.length === 0) return;
            loadingStatus.style.display = "block";
            try {
                const response = await fetch('https://finans.mynet.com/borsa/hisseler/');
                const text = await response.text();
                const parser = new DOMParser();
                const docObj = parser.parseFromString(text, 'text/html');
                const rows = docObj.querySelectorAll('tr');

                for (const h of hisseler) {
                    let yeniFiyat = 0;
                    rows.forEach(row => {
                        const hisseKod = row.querySelector('strong a')?.textContent.trim();
                        if (hisseKod && hisseKod.includes(h.ad.replace('-CARI', ''))) {
                            const fiyatMetni = row.querySelectorAll('td')[2]?.textContent.trim();
                            yeniFiyat = parseFloat(fiyatMetni.replace('.', '').replace(',', '.'));
                        }
                    });

                    if (yeniFiyat > 0) {
                        const docRef = doc(db, 'artifacts', appId, 'users', currentUser.uid, 'hisseler', h.ad);
                        await updateDoc(docRef, { fiyat: yeniFiyat });
                    }
                }
            } catch (error) {
                console.error("Fiyat çekme hatası:", error);
                alert("Fiyatlar güncellenemedi. Tarayıcı kısıtlaması (CORS) olabilir.");
            } finally {
                loadingStatus.style.display = "none";
            }
        };

    </script>
</body>
</html>
