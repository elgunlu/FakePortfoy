<!DOCTYPE html>
<html lang="tr">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Hisse Portföyü</title>
    <!-- Tailwind CSS CDN --><script src="https://cdn.tailwindcss.com"></script>
    <!-- Lucide Icons for vector icons --><script src="https://unpkg.com/lucide@latest"></script>
    <style>
        /* Inter font for a clean, modern look */
        @import url('https://fonts.googleapis.com/css2?family=Inter:wght@100..900&display=swap');
        
        body {
            font-family: 'Inter', sans-serif;
            background-color: #f7f7f7; /* Hafif gri arka plan */
        }
        
        /* Özel Turuncu/Sarı Tonu - Başlık Rengi */
        .header-bg {
            background-color: #fcae01; /* Ekrandaki turuncu tona yakın */
        }

        /* Sekmeler için özel stil */
        .tab-active {
            /* Bu stil artık kullanılmıyor çünkü tab navigasyon statik ve border-b-2 ile yapılıyor */
            color: black;
            font-weight: 600;
        }

        /* Tüm detay başlıkları için küçük, açık gri stil */
        .detail-label {
            font-size: 0.7rem;
            color: #6b7280; /* Gray-500 */
            white-space: nowrap; /* Başlıkların kırılmasını engeller */
        }

        /* Açık mavi çubuk rengi */
        .light-blue-bar {
            background-color: #ADD8E6; /* Light Blue */
        }
    </style>
</head>
<body>

    <!-- Ana uygulama konteyneri (h-screen ve flex-col eklenerek tam ekran ve dikey düzen sağlandı) --><div id="app" class="max-w-md mx-auto bg-white h-screen shadow-lg flex flex-col">

        <!-- YENİ 0. STATÜS BARI (Sabit Kalacak) --><div id="status-bar" class="flex justify-between items-center px-4 py-2 header-bg text-gray-800">
            <!-- Sol: Güncel Saat --><span id="current-time" class="text-base font-medium mt-2"></span>
            <!-- Sağ: Simge --><img id="status-icon" src="https://i.imgur.com/EILFjgD.png" alt="Statü Simgesi" class="w-1/2 rounded-sm"
                 onerror="this.onerror=null; this.src='https://placehold.co/20x20/ffffff/000000?text=S'">
        </div>
        
        <!-- 1. HEADER (Başlık Çubuğu - Sabit Kalacak) --><header class="header-bg p-4 flex items-center justify-between text-gray-700 shadow-md">
            <div class="flex items-center space-x-4">
                <!-- Solundaki < işareti koyu gri yapıldı --><a href="index.html" class="text-gray-800 hover:text-gray-900 transition duration-150">
                    <i data-lucide="chevron-left" class="w-6 h-6"></i>
                </a>
                <h1 class="text-gray-800">Hisse Portföy</h1>
            </div>
            <img src="https://i.imgur.com/Us12XRm.png" alt="tradeumine Logo" class="w-6 h-6 rounded-sm" 
                 onerror="this.onerror=null; this.src='https://placehold.co/32x32/fca311/ffffff?text=Logo'">
        </header>

        <!-- 2. TAB NAV (Sekmeler - Sabit Kalacak) --><nav class="flex justify-around bg-white text-gray-500 border-b border-gray-200">
            <div class="tab-active p-3 text-center w-1/2 text-black border-b-2 border-amber-500">
                PORTFÖYÜM
            </div>
            <div class="p-3 text-center w-1/2 hover:text-gray-700">
                EMİRLERİM
            </div>
        </nav>
        
        <!-- 3. STOCK PORTFOLIO LIST ve 4. Form (Kaydırılabilir Ana İçerik) -->
        <!-- flex-1: Kalan tüm dikey alanı kaplar. overflow-y-auto: İçerik taştığında dikey kaydırmayı sağlar. -->
        <main class="bg-[#f7f7f7] p-2 space-y-2 pb-8 overflow-y-auto flex-1">

            <!-- YENİ EKLENEN: Yatırım Hesabım Kartı (Görseldeki Özet Bölümü) --><div id="account-summary" class="bg-white p-4 rounded-lg shadow-md">
                <h2 class="text-xl font-bold text-gray-800 mb-1">Yatırım Hesabım</h2>
                <!-- Hesap Numarası --><p class="text-sm text-gray-500 mb-4" id="account-id">52070463</p>

                <!-- Portföy & Kar/Zarar Bölümü --><div class="flex border-b border-gray-200 pb-4 mb-4">
                    <div class="w-1/2 pr-4 border-r border-gray-200">
                        <div class="text-sm text-gray-500 mb-1">Portföy</div>
                        <div class="text-lg font-bold" id="total-portfolio-value">0,00 TL</div>
                    </div>
                    <div class="w-1/2 pl-4">
                        <div class="text-sm text-gray-500 mb-1">Kâr/Zarar</div>
                        <!-- Değer yeşil/kırmızı renkte olacak -->
                        <div class="text-lg font-bold" id="total-profit-loss">+0,00 TL</div>
                    </div>
                </div>

                <!-- Limitler ve Bakiyeler --><div class="space-y-3 text-sm">
                    <div class="flex justify-between items-center">
                        <div class="flex items-center text-gray-700">
                            Borsa İşlem Limiti
                            <!-- Bilgi ikonu --><i data-lucide="info" class="w-4 h-4 text-amber-500 ml-1"></i>
                        </div>
                        <div id="borsa-limit" class="font-semibold">0,00 TL</div>
                    </div>
                    <div class="flex justify-between items-center">
                        <div class="text-gray-700">T+2 Bakiyesi</div>
                        <div id="t2-bakiyesi" class="font-semibold">0,00 TL</div>
                    </div>

                    <!-- YENİ EKLENECEK BAKİYELER (Gizli Başlangıç) --><div id="more-balances-container" class="space-y-3 hidden">
                        <div class="flex justify-between items-center border-t border-gray-100 pt-3">
                            <div class="text-gray-700">T+1 Bakiyesi</div>
                            <div id="t1-bakiyesi" class="font-semibold">0,00 TL</div>
                        </div>
                        <div class="flex justify-between items-center">
                            <div class="text-gray-700">TL Bakiyesi</div>
                            <div id="tl-bakiyesi" class="font-semibold">0,00 TL</div>
                        </div>
                        <div class="flex justify-between items-center">
                            <div class="text-gray-700">Bloke Bakiyesi</div>
                            <div id="bloke-bakiyesi" class="font-semibold">0,00 TL</div>
                        </div>
                    </div>
                </div>

                <!-- Daha Fazla/Az Göster --><div class="text-center mt-6">
                    <a href="#" id="toggle-balances-link" class="text-amber-500 font-medium text-sm hover:text-amber-600 transition">Daha Fazla Göster</a>
                </div>
            </div>
            <br>

            <!-- BMSTL.E (YÜKSELİŞ) --><div id="card-BMSTL.E" class="stock-card bg-white p-4 rounded-lg shadow-sm">
                <!-- Üst Satır (Hisse Adı ve Toplam Değer) --><div class="flex justify-between items-center mb-2">
                    <h2 class="text-lg font-bold">BMSTL.E</h2>
                    <div class="flex items-center space-x-2">
                        <span id="total-value-BMSTL.E" class="text-xl font-bold">98.390,53 TL</span>
                        <i data-lucide="chevron-right" class="w-5 h-5 text-gray-400"></i>
                    </div>
                </div>

                <!-- Oranlar (Küçük Yüzde ve Büyük Değişim) --><div class="flex justify-between items-end mb-2">
                    <!-- Sol: Küçük Yüzde - Portföy Payı --><span id="portfolio-percent-BMSTL.E" class="text-green-600 text-xs font-medium">%76.04</span>
                    <!-- Sağ: Değişim (Büyük Font) --><div class="text-right"> 
                        <div id="change-container-BMSTL.E" class="text-sm font-semibold text-green-600 flex items-center">
                            <i id="change-icon-BMSTL.E" data-lucide="triangle" class="w-3 h-3 fill-green-600 mr-1 rotate-180"></i>
                            <span id="change-percent-BMSTL.E">%214,37</span>
                            <span id="change-amount-BMSTL.E" class="text-xs font-normal ml-1">(+67.093,08 TL)</span>
                        </div>
                    </div>
                </div>

                <!-- Grafik Çubuğu (Tam Genişlikte, ayrı satırda) --><div class="w-full h-2 bg-gray-200 rounded-full mb-3">
                    <div id="progress-bar-BMSTL.E" class="h-2 light-blue-bar rounded-full" style="width: 76.04%;"></div>
                </div>

                <!-- Detaylar (3 Sütunlu Grid) --><div class="grid grid-cols-3 gap-2 text-sm">
                    <div>
                        <div class="detail-label">Satılabilir Adet</div>
                        <div id="quantity-BMSTL.E" class="font-medium">1.186,00</div>
                    </div>
                    <div>
                        <div class="detail-label">Maliyet*</div>
                        <div id="cost-price-BMSTL.E" class="font-medium">26,37 TL</div>
                    </div>
                    <div>
                        <div class="detail-label">Son İşlem Fiyatı</div>
                        <div id="last-price-BMSTL.E" class="font-medium">82,90 TL</div>
                    </div>
                </div>
            </div>

            <!-- HKTM.E (DÜŞÜŞ) --><div id="card-HKTM.E" class="stock-card bg-white p-4 rounded-lg shadow-sm">
                <!-- Üst Satır (Hisse Adı ve Toplam Değer) --><div class="flex justify-between items-center mb-2">
                    <h2 class="text-lg font-bold">HKTM.E</h2>
                    <div class="flex items-center space-x-2">
                        <span id="total-value-HKTM.E" class="text-xl font-bold">31.000,00 TL</span>
                        <i data-lucide="chevron-right" class="w-5 h-5 text-gray-400"></i>
                    </div>
                </div>

                <!-- Oranlar (Küçük Yüzde ve Büyük Değişim) --><div class="flex justify-between items-end mb-2">
                    <!-- Sol: Küçük Yüzde - Portföy Payı --><span id="portfolio-percent-HKTM.E" class="text-gray-600 text-xs font-medium">%23.96</span>
                    <!-- Sağ: Değişim (Büyük Font) --><div class="text-right">
                        <div id="change-container-HKTM.E" class="text-sm font-semibold text-red-600 flex items-center">
                            <i id="change-icon-HKTM.E" data-lucide="triangle" class="w-3 h-3 fill-red-600 mr-1"></i>
                            <span id="change-percent-HKTM.E">-%10,79</span>
                            <span id="change-amount-HKTM.E" class="text-xs font-normal ml-1">(-3.750,00 TL)</span>
                        </div>
                    </div>
                </div>

                <!-- Grafik Çubuğu (Tam Genişlikte, ayrı satırda) --><div class="w-full h-2 bg-gray-200 rounded-full mb-3">
                    <div id="progress-bar-HKTM.E" class="h-2 light-blue-bar rounded-full" style="width: 23.96%;"></div>
                </div>

                <!-- Detaylar (3 Sütunlu Grid) --><div class="grid grid-cols-3 gap-2 text-sm">
                    <div>
                        <div class="detail-label">Satılabilir Adet</div>
                        <div id="quantity-HKTM.E" class="font-medium">2.500,00</div>
                    </div>
                    <div>
                        <div class="detail-label">Maliyet*</div>
                        <div id="cost-price-HKTM.E" class="font-medium">13,90 TL</div>
                    </div>
                    <div>
                        <div class="detail-label">Son İşlem Fiyatı</div>
                        <div id="last-price-HKTM.E" class="font-medium">12,40 TL</div>
                    </div>
                </div>
            </div>
            <br><br><br><br><br><br><br><br><br><br><br><br><br>
            <!-- Not: Yapay boşluk oluşturmak için kullanılan <br> etiketleri kaldırıldı. -->

            <!-- 4. Hisse Güncelleme Formu (Kaydırılabilir) --><div id="form-container" class="bg-white shadow-md p-4 rounded-lg border-t-4 border-amber-500">
                <h3 class="text-lg font-semibold mb-3 border-b pb-2">Hisse ve Hesap Verilerini Güncelle</h3>
                <form id="update-form">
                    <!-- Hisse Seçimi --><div class="mb-3">
                        <label for="stock-select" class="detail-label block mb-1">Hisse Kodu Seçin</label>
                        <select id="stock-select" class="w-full p-2 border border-gray-300 rounded-md focus:ring-amber-500 focus:border-amber-500">
                            <option value="BMSTL.E">BMSTL.E</option>
                            <option value="HKTM.E">HKTM.E</option>
                        </select>
                    </div>

                    <!-- Satılabilir Adet --><div class="mb-3">
                        <label for="input-quantity" class="detail-label block mb-1">Satılabilir Adet</label>
                        <input type="number" id="input-quantity" class="w-full p-2 border border-gray-300 rounded-md focus:ring-amber-500 focus:border-amber-500" step="0.01">
                    </div>

                    <!-- Maliyet* --><div class="mb-3">
                        <label for="input-cost-price" class="detail-label block mb-1">Maliyet* (TL)</label>
                        <input type="number" id="input-cost-price" class="w-full p-2 border border-gray-300 rounded-md focus:ring-amber-500 focus:border-amber-500" step="0.01">
                    </div>

                    <!-- Son İşlem Fiyatı --><div class="mb-3">
                        <label for="input-last-price" class="detail-label block mb-1">Son İşlem Fiyatı (TL)</label>
                        <input type="number" id="input-last-price" class="w-full p-2 border border-gray-300 rounded-md focus:ring-amber-500 focus:border-amber-500" step="0.01">
                    </div>
                    
                    <!-- Borsa ve T+2 Limitleri --><div class="mb-3 border-t pt-3 mt-3">
                        <label for="input-borsa-limit" class="detail-label block mb-1 font-semibold text-gray-700">Borsa İşlem Limiti (TL)</label>
                        <input type="number" id="input-borsa-limit" class="w-full p-2 border border-gray-300 rounded-md focus:ring-amber-500 focus:border-amber-500" step="0.01">
                    </div>
                    
                    <!-- T+2 Bakiyesi --><div class="mb-3">
                        <label for="input-t2-balance" class="detail-label block mb-1 font-semibold text-gray-700">T+2 Bakiyesi (TL)</label>
                        <input type="number" id="input-t2-balance" class="w-full p-2 border border-gray-300 rounded-md focus:ring-amber-500 focus:border-amber-500" step="0.01">
                    </div>

                    <!-- YENİ ALAN: T+1 Bakiyesi --><div class="mb-3">
                        <label for="input-t1-balance" class="detail-label block mb-1 font-semibold text-gray-700">T+1 Bakiyesi (TL)</label>
                        <input type="number" id="input-t1-balance" class="w-full p-2 border border-gray-300 rounded-md focus:ring-amber-500 focus:border-amber-500" step="0.01">
                    </div>

                    <!-- YENİ ALAN: TL Bakiyesi --><div class="mb-3">
                        <label for="input-tl-balance" class="detail-label block mb-1 font-semibold text-gray-700">TL Bakiyesi (TL)</label>
                        <input type="number" id="input-tl-balance" class="w-full p-2 border border-gray-300 rounded-md focus:ring-amber-500 focus:border-amber-500" step="0.01">
                    </div>

                    <!-- YENİ ALAN: Bloke Bakiyesi --><div class="mb-5">
                        <label for="input-bloke-balance" class="detail-label block mb-1 font-semibold text-gray-700">Bloke Bakiyesi (TL)</label>
                        <input type="number" id="input-bloke-balance" class="w-full p-2 border border-gray-300 rounded-md focus:ring-amber-500 focus:border-amber-500" step="0.01">
                    </div>


                    <button type="submit" class="w-full bg-amber-500 text-white font-semibold py-2 rounded-md hover:bg-amber-600 transition duration-150">
                        Verileri Kaydet ve Güncelle
                    </button>
                    <div id="message-box" class="mt-3 p-2 text-sm text-center rounded-md hidden"></div>
                </form>
            </div>
            
        </main>
        
    </div>

    <script type="module">
        // Hisse senedi verilerini saklayan merkezi obje (Varsayılan değerler)
        let stocks = {}; 
        // Hesap genel limit ve bakiyelerini saklayan merkezi obje
        let accountDetails = {}; 

        // LocalStorage Anahtarları
        const STOCK_KEY = 'portfolioStocks';
        const ACCOUNT_DETAILS_KEY = 'portfolioAccountDetails'; 

        // Statü çubuğunda rastgele gösterilecek resim URL'leri
        const IMAGE_URLS = [
            "https://i.imgur.com/LIvAA9i.png",
            "https://i.imgur.com/o8d9pDs.png",
            "https://i.imgur.com/SD90fP5.png"
        ];


        // Varsayılan hisse verilerini tanımla
        const defaultStocks = {
            'BMSTL.E': { 
                quantity: 1186.00, 
                costPrice: 26.37, 
                lastPrice: 82.90
            },
            'HKTM.E': { 
                quantity: 2500.00, 
                costPrice: 13.90, 
                lastPrice: 12.40
            }
        };
        
        // Varsayılan hesap detay verilerini tanımla (YENİ ALANLAR EKLENDİ)
        const defaultAccountDetails = {
            borsaLimit: 0.00,
            t2Balance: 0.00,
            t1Balance: 0.00, // YENİ
            tlBalance: 0.00, // YENİ
            blokeBalance: 0.00 // YENİ
        };

        // Form elementlerini seçme (YENİ ALANLAR EKLENDİ)
        const stockSelect = document.getElementById('stock-select');
        const inputQuantity = document.getElementById('input-quantity');
        const inputCostPrice = document.getElementById('input-cost-price');
        const inputLastPrice = document.getElementById('input-last-price');
        const inputBorsaLimit = document.getElementById('input-borsa-limit'); 
        const inputT2Balance = document.getElementById('input-t2-balance');
        const inputT1Balance = document.getElementById('input-t1-balance'); // YENİ
        const inputTlBalance = document.getElementById('input-tl-balance');   // YENİ
        const inputBlokeBalance = document.getElementById('input-bloke-balance'); // YENİ
        
        const toggleLink = document.getElementById('toggle-balances-link'); // YENİ
        const moreBalancesContainer = document.getElementById('more-balances-container'); // YENİ

        const updateForm = document.getElementById('update-form');
        const messageBox = document.getElementById('message-box');
        const statusIcon = document.getElementById('status-icon');


        // --- YARDIMCI İŞLEMLER ---

        /**
         * IMAGE_URLS dizisinden rastgele bir resim seçer ve statü simgesini günceller.
         */
        function setRandomStatusIcon() {
            if (statusIcon && IMAGE_URLS.length > 0) {
                const randomIndex = Math.floor(Math.random() * IMAGE_URLS.length);
                const randomUrl = IMAGE_URLS[randomIndex];
                statusIcon.src = randomUrl;
            }
        }

        // --- ZAMAN GÜNCELLEME İŞLEMİ ---

        /**
         * Güncel saati alıp üst çubuğa yazar.
         */
        function updateTime() {
            const timeElement = document.getElementById('current-time');
            if (timeElement) {
                // Türkiye saat formatı (HH:mm)
                const now = new Date();
                const timeString = now.toLocaleTimeString('tr-TR', { hour: '2-digit', minute: '2-digit' });
                timeElement.textContent = timeString;
            }
        }
        
        // Saati her saniye güncellemek için ayarla
        setInterval(updateTime, 1000); 
        updateTime(); // Başlangıçta hemen çağır

        // --- LOCAL STORAGE İŞLEMLERİ ---

        /**
         * Hesap detaylarını localStorage'dan yükler.
         */
        function loadAccountDetailsFromLocalStorage() {
            const storedData = localStorage.getItem(ACCOUNT_DETAILS_KEY);
            let loadedDetails;
            if (storedData) {
                try {
                    loadedDetails = JSON.parse(storedData);
                    console.log("Account details loaded from LocalStorage.");
                } catch (e) {
                    console.error("Error parsing stored account details:", e);
                    loadedDetails = defaultAccountDetails;
                }
            } else {
                loadedDetails = defaultAccountDetails;
            }
            // Varsayılanları yüklenen verilerle birleştir (Yeni alanlar için 0.00 sağlamak için)
            accountDetails = {...defaultAccountDetails, ...loadedDetails}; 
            saveAccountDetailsToLocalStorage(); // Yeni alanları kaydetmek için tekrar kaydet
            fillAccountDetailsForm(); 
        }

        /**
         * Mevcut hesap detay verilerini localStorage'a kaydeder.
         */
        function saveAccountDetailsToLocalStorage() {
            try {
                localStorage.setItem(ACCOUNT_DETAILS_KEY, JSON.stringify(accountDetails));
                console.log("Account details saved to LocalStorage successfully.");
            } catch (e) {
                console.error("Error saving account details to LocalStorage:", e);
                showMessage("Hesap detayları yerel olarak kaydedilemedi.", 'bg-red-100 text-red-800');
            }
        }

        /**
         * Hisse verilerini localStorage'dan yükler.
         */
        function loadStocksFromLocalStorage() {
            const storedData = localStorage.getItem(STOCK_KEY);
            if (storedData) {
                try {
                    // Yerel olarak depolanan veriyi kullan
                    stocks = JSON.parse(storedData);
                    console.log("Stocks loaded from LocalStorage.");
                } catch (e) {
                    console.error("Error parsing stored data:", e);
                    stocks = defaultStocks;
                }
            } else {
                // Veri yoksa, varsayılanları kullan ve kaydet
                stocks = defaultStocks;
                console.log("No data found in LocalStorage, using default data.");
                saveStocksToLocalStorage();
            }
            // Bu kısımda sadece hisse verilerini form alanlarına dolduruyoruz.
            fillFormWithSelectedStock(); 
        }

        /**
         * Mevcut hisse verilerini localStorage'a kaydeder.
         */
        function saveStocksToLocalStorage() {
            try {
                localStorage.setItem(STOCK_KEY, JSON.stringify(stocks));
                console.log("Stocks saved to LocalStorage successfully.");
            } catch (e) {
                console.error("Error saving data to LocalStorage:", e);
                // Kullanıcıya bir hata mesajı gösterilebilir
                showMessage("Hisse verileri yerel olarak kaydedilemedi (Depolama Alanı Hatası).", 'bg-red-100 text-red-800');
            }
        }


        // --- UI VE HESAPLAMA İŞLEMLERİ ---

        /**
         * Gizli bakiye detaylarını gösterir/gizler ve link metnini günceller.
         */
        function toggleMoreBalances(event) {
            event.preventDefault();
            
            if (moreBalancesContainer.classList.contains('hidden')) {
                // Gizliyse, göster
                moreBalancesContainer.classList.remove('hidden');
                toggleLink.textContent = 'Daha Az Göster';
            } else {
                // Görünürse, gizle
                moreBalancesContainer.classList.add('hidden');
                toggleLink.textContent = 'Daha Fazla Göster';
            }
        }

        /**
         * Sayfadaki tüm hisse verilerini ve portföy yüzdelerini günceller.
         */
        function updatePortfolioView() {
            let totalPortfolioValue = 0;
            let totalProfitLossAmount = 0; 
            const stockKeys = Object.keys(stocks);
            
            // Helper function to format currency
            const formatCurrency = (value) => (value || 0).toLocaleString('tr-TR', { 
                style: 'currency', 
                currency: 'TRY',
                minimumFractionDigits: 2, 
                maximumFractionDigits: 2
            });


            // 1. Her hissenin toplam değerini ve K/Z miktarını hesapla ve genel portföy toplamını bul
            stockKeys.forEach(code => {
                const stock = stocks[code];
                // Sayısal değerler için kontrol
                stock.quantity = parseFloat(stock.quantity) || 0;
                stock.costPrice = parseFloat(stock.costPrice) || 0;
                stock.lastPrice = parseFloat(stock.lastPrice) || 0;

                stock.totalValue = stock.quantity * stock.lastPrice;
                const totalCost = stock.quantity * stock.costPrice;
                stock.profitAmount = stock.totalValue - totalCost; // K/Z Miktarı

                totalPortfolioValue += stock.totalValue;
                totalProfitLossAmount += stock.profitAmount; // K/Z Miktarını topla
            });
            
            // Genel Portföy Özeti Güncelleme
            const totalPortfolioValueElement = document.getElementById('total-portfolio-value');
            const totalProfitLossElement = document.getElementById('total-profit-loss');
            
            if (totalPortfolioValueElement) {
                totalPortfolioValueElement.textContent = formatCurrency(totalPortfolioValue);
            }

            if (totalProfitLossElement) {
                const isOverallProfit = totalProfitLossAmount >= -0.01;
                const sign = isOverallProfit ? '+' : '-'; 
                const colorClass = isOverallProfit ? 'text-green-600' : 'text-red-600';

                // Renk sınıfını ayarla
                totalProfitLossElement.classList.remove('text-green-600', 'text-red-600');
                totalProfitLossElement.classList.add(colorClass);

                const formattedProfit = Math.abs(totalProfitLossAmount).toLocaleString('tr-TR', { 
                    style: 'currency', 
                    currency: 'TRY',
                    minimumFractionDigits: 2, 
                    maximumFractionDigits: 2
                });

                // Baştaki para birimi ibaresini kaldırıp sadece + veya - işareti ile göster
                const displayValue = `${sign}${formattedProfit.replace('₺', '').trim()}`;
                totalProfitLossElement.textContent = displayValue;

                // T+2 ve Borsa Limitini accountDetails'den oku ve güncelle
                const borsaLimitElement = document.getElementById('borsa-limit');
                const t2BakiyeElement = document.getElementById('t2-bakiyesi');
                // YENİ EKLEMELER
                const t1BakiyeElement = document.getElementById('t1-bakiyesi');
                const tlBakiyeElement = document.getElementById('tl-bakiyesi');
                const blokeBakiyeElement = document.getElementById('bloke-bakiyesi');

                if (borsaLimitElement) {
                    borsaLimitElement.textContent = formatCurrency(accountDetails.borsaLimit);
                }
                if (t2BakiyeElement) {
                    t2BakiyeElement.textContent = formatCurrency(accountDetails.t2Balance);
                }
                // YENİ ALANLARIN GÜNCELLENMESİ
                if (t1BakiyeElement) {
                    t1BakiyeElement.textContent = formatCurrency(accountDetails.t1Balance);
                }
                if (tlBakiyeElement) {
                    tlBakiyeElement.textContent = formatCurrency(accountDetails.tlBalance);
                }
                if (blokeBakiyeElement) {
                    blokeBakiyeElement.textContent = formatCurrency(accountDetails.blokeBalance);
                }
            }

            // 2. Her hissenin portföydeki payını, Kar/Zarar oranını hesapla ve DOM'u güncelle
            stockKeys.forEach(code => {
                const stock = stocks[code];
                
                // Finansal Hesaplamalar
                const totalCost = stock.quantity * stock.costPrice;
                const profitAmount = stock.profitAmount; 
                const profitPercent = totalCost > 0 ? (profitAmount / totalCost) * 100 : 0;
                const isProfit = profitAmount >= -0.01; 

                // DOM Elementleri
                const totalValueElement = document.getElementById(`total-value-${code}`);
                const quantityElement = document.getElementById(`quantity--${code}`);
                const costPriceElement = document.getElementById(`cost-price-${code}`);
                const lastPriceElement = document.getElementById(`last-price-${code}`);
                const portfolioPercentElement = document.getElementById(`portfolio-percent-${code}`);
                const progressBar = document.getElementById(`progress-bar-${code}`);
                const changeContainerElement = document.getElementById(`change-container-${code}`);
                const changeIconElement = document.getElementById(`change-icon-${code}`);
                const changePercentElement = document.getElementById(`change-percent-${code}`);
                const changeAmountElement = document.getElementById(`change-amount-${code}`);

                // --- GÖRÜNÜM GÜNCELLEMELERİ ---
                
                // Portföy Payı Hesaplama ve Çubuk
                const percent = totalPortfolioValue > 0 ? (stock.totalValue / totalPortfolioValue) * 100 : 0;
                portfolioPercentElement.textContent = `%${percent.toFixed(2)}`;
                progressBar.style.width = `${percent}%`;

                // Renk ve Stil Ayarları
                if (changeContainerElement) {
                    changeContainerElement.classList.remove('text-green-600', 'text-red-600');
                    changeIconElement.classList.remove('fill-green-600', 'fill-red-600', 'rotate-180');

                    if (isProfit) {
                        changeContainerElement.classList.add('text-green-600');
                        changeIconElement.classList.add('fill-green-600', 'rotate-180');
                    } else {
                        changeContainerElement.classList.add('text-red-600');
                        changeIconElement.classList.add('fill-red-600');
                    }
                }

                // Kar/Zarar Yüzde Metni
                const formattedPercent = Math.abs(profitPercent).toFixed(2).replace('.', ',');
                const sign = isProfit ? '+' : '-';
                changePercentElement.textContent = `%${sign}${formattedPercent}`;
                
                // Kar/Zarar Miktar Metni
                const formattedAmount = Math.abs(profitAmount).toLocaleString('tr-TR', { minimumFractionDigits: 2, maximumFractionDigits: 2 });
                const amountSign = isProfit ? '+' : ''; 
                changeAmountElement.textContent = `(${amountSign}${formattedAmount} TL)`;

                // Temel Veriler
                totalValueElement.textContent = formatCurrency(stock.totalValue);
                if(quantityElement) quantityElement.textContent = stock.quantity.toFixed(2).replace('.', ',');
                if(costPriceElement) costPriceElement.textContent = stock.costPrice.toFixed(2).replace('.', ',') + ' TL';
                if(lastPriceElement) lastPriceElement.textContent = stock.lastPrice.toFixed(2).replace('.', ',') + ' TL';
            });
        }

        /**
         * Seçilen hissenin verilerini form alanlarına doldurur.
         */
        function fillFormWithSelectedStock() {
            const selectedCode = stockSelect.value;
            const stock = stocks[selectedCode];
            
            if (stock) {
                // Not: Form alanlarına virgül yerine nokta kullanılmalı (step="0.01" nedeniyle)
                inputQuantity.value = stock.quantity;
                inputCostPrice.value = stock.costPrice;
                inputLastPrice.value = stock.lastPrice;
            }
            // Bu fonksiyon sadece hisse detaylarını doldurur, genel hesap detayları ayrı doldurulur.
        }
        
        /**
         * Genel hesap detaylarını form alanlarına doldurur.
         */
        function fillAccountDetailsForm() {
            inputBorsaLimit.value = accountDetails.borsaLimit || 0;
            inputT2Balance.value = accountDetails.t2Balance || 0;
            // YENİ EKLENEN BAKİYELER
            inputT1Balance.value = accountDetails.t1Balance || 0;
            inputTlBalance.value = accountDetails.tlBalance || 0;
            inputBlokeBalance.value = accountDetails.blokeBalance || 0;
        }


        /**
         * Form gönderimini işler ve verileri günceller.
         */
        function handleFormSubmit(event) {
            event.preventDefault();
            
            const selectedCode = stockSelect.value;
            // Hisse verisi okuma
            const newQuantity = parseFloat(inputQuantity.value.replace(',', '.'));
            const newCostPrice = parseFloat(inputCostPrice.value.replace(',', '.'));
            const newLastPrice = parseFloat(inputLastPrice.value.replace(',', '.'));

            // Hesap detayı okuma
            const newBorsaLimit = parseFloat(inputBorsaLimit.value.replace(',', '.'));
            const newT2Balance = parseFloat(inputT2Balance.value.replace(',', '.'));
            const newT1Balance = parseFloat(inputT1Balance.value.replace(',', '.')); // YENİ
            const newTlBalance = parseFloat(inputTlBalance.value.replace(',', '.'));   // YENİ
            const newBlokeBalance = parseFloat(inputBlokeBalance.value.replace(',', '.')); // YENİ


            // Basit doğrulama
            if (isNaN(newQuantity) || isNaN(newCostPrice) || isNaN(newLastPrice) || 
                isNaN(newBorsaLimit) || isNaN(newT2Balance) || 
                isNaN(newT1Balance) || isNaN(newTlBalance) || isNaN(newBlokeBalance)) {
                showMessage("Lütfen tüm alanlara geçerli sayısal değerler girin.", 'bg-red-100 text-red-800');
                return;
            }

            // Hisse Verisini Güncelle
            stocks[selectedCode].quantity = newQuantity;
            stocks[selectedCode].costPrice = newCostPrice;
            stocks[selectedCode].lastPrice = newLastPrice;

            // Hesap Detaylarını Güncelle
            accountDetails.borsaLimit = newBorsaLimit;
            accountDetails.t2Balance = newT2Balance;
            accountDetails.t1Balance = newT1Balance; // YENİ
            accountDetails.tlBalance = newTlBalance; // YENİ
            accountDetails.blokeBalance = newBlokeBalance; // YENİ


            // Görünümü güncelle ve yerel olarak kaydet
            updatePortfolioView();
            saveStocksToLocalStorage();
            saveAccountDetailsToLocalStorage();
            showMessage(`Hisse (${selectedCode}) ve Hesap Detayları başarıyla güncellendi ve yerel olarak kaydedildi.`, 'bg-green-100 text-green-800');
        }

        /**
         * Kullanıcıya bilgi/hata mesajı gösterir.
         */
        function showMessage(message, classes) {
            messageBox.textContent = message;
            messageBox.className = `mt-3 p-2 text-sm text-center rounded-md ${classes}`;
            messageBox.classList.remove('hidden');
            setTimeout(() => {
                messageBox.classList.add('hidden');
            }, 5000);
        }

        // Olay dinleyicileri
        stockSelect.addEventListener('change', fillFormWithSelectedStock);
        updateForm.addEventListener('submit', handleFormSubmit);
        // YENİ OLAY DİNLEYİCİSİ
        toggleLink.addEventListener('click', toggleMoreBalances); 

        // Sayfa yüklendiğinde:
        window.onload = function() {
            lucide.createIcons();
            loadAccountDetailsFromLocalStorage(); // Önce hesap detaylarını yükle
            loadStocksFromLocalStorage();         // Ardından hisse verilerini yükle
            updatePortfolioView();               // Tüm görünümü güncelle
            setRandomStatusIcon();               // Rastgele statü simgesini ayarla
        }
    </script>
</body>
</html>