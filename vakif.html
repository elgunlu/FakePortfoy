<!DOCTYPE html>
<html lang="tr">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Hisse Portföyü</title>
    <!-- Tailwind CSS CDN --><script src="https://cdn.tailwindcss.com"></script>
    <!-- Lucide Icons for vector icons --><script src="https://unpkg.com/lucide@latest"></script>
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Inter:wght@100..900&display=swap');
        
        body {
            font-family: 'Inter', sans-serif;
            background-color: #f7f7f7;
        }
        
        .header-bg {
            background-color: #fcae01;
        }

        .detail-label {
            font-size: 0.7rem;
            color: #6b7280;
            white-space: nowrap;
        }

        .light-blue-bar {
            background-color: #ADD8E6;
        }

        .tab-content { display: none; }
        .tab-content.active { display: block; }
        .tab-button { cursor: pointer; transition: all 0.2s; }

        .outer-white-box {
            background-color: white;
            padding: 1rem;
            border-radius: 0.75rem;
            box-shadow: 0 1px 2px rgba(0,0,0,0.05);
        }

        .date-range-outline {
            position: relative;
            border: 1.5px solid #e5e7eb;
            border-radius: 0.5rem;
            padding: 0.75rem 0.75rem;
            margin-top: 0.5rem;
        }

        .date-range-label {
            position: absolute;
            top: -10px;
            left: 10px;
            background-color: white;
            padding: 0 4px;
            font-size: 16px;
            color: #9ca3af;
            font-weight: 500;
        }

        .strike-container {
            position: relative;
            display: inline-block;
        }

        .strike-line {
            position: absolute;
            top: 50%;
            left: 50%;
            width: 90%;
            height: 4px;
            background-color: #1f2937;
            transform: translate(-50%, -50%) rotate(-45deg);
            pointer-events: none;
            border-radius: 2px;
        }
        .strike-line2 {
            position: absolute;
            top:53%;
            left: 50%;
            width: 90%;
            height: 6px;
            background-color: white;
            transform: translate(-50%, -50%) rotate(-45deg);
            pointer-events: none;
            border-radius: 2px;
        }
    </style>
</head>
<body>

    <div id="app" class="max-w-md mx-auto bg-white h-screen shadow-lg flex flex-col">

        <!-- 0. STATÜS BARI -->
        <div id="status-bar" class="flex justify-between items-center px-4 py-2 header-bg text-gray-800">
            <span id="current-time" class="text-base font-medium mt-2"></span>
            <img id="status-icon" src="https://i.imgur.com/EILFjgD.png" alt="Statü Simgesi" class="w-1/2 rounded-sm">
        </div>
        
        <!-- 1. HEADER -->
        <header class="header-bg p-4 flex items-center justify-between text-gray-700 shadow-md">
            <div class="flex items-center space-x-4">
                <button onclick="switchTab('portfolio')" class="text-gray-800 hover:text-gray-900 transition duration-150">
                    <i data-lucide="chevron-left" class="w-6 h-6"></i>
                </button>
                <h1 id="page-title" class="text-gray-800 font-semibold text-lg">Hisse Portföy</h1>
            </div>
            <!-- Logo Butonu -->
            <button onclick="toggleUpdateForm()" class="focus:outline-none active:opacity-70 transition-opacity">
                <img src="https://i.imgur.com/Us12XRm.png" alt="Logo" class="w-6 h-6 rounded-sm">
            </button>
        </header>

        <!-- 2. TAB NAV -->
        <nav class="flex justify-around bg-white text-gray-500 border-b border-gray-200">
            <div id="tab-btn-portfolio" onclick="switchTab('portfolio')" class="tab-button p-3 text-center w-1/2 text-black border-b-2 border-amber-500 font-bold">
                PORTFÖYÜM
            </div>
            <div id="tab-btn-orders" onclick="switchTab('orders')" class="tab-button p-3 text-center w-1/2 hover:text-gray-700">
                EMİRLERİM
            </div>
        </nav>
        
        <!-- 3. ANA İÇERİK -->
        <div class="flex-1 overflow-y-auto bg-[#f7f7f7]">

            <!-- SEKME 1: PORTFÖYÜM -->
            <main id="tab-content-portfolio" class="tab-content active p-2 space-y-2 pb-8">

                <!-- Yatırım Hesabım Kartı -->
                <div id="account-summary" class="bg-white p-4 rounded-lg shadow-md">
                    <h2 class="text-xl font-bold text-gray-800 mb-1">Yatırım Hesabım</h2>
                    <p class="text-sm text-gray-500 mb-4" id="account-id">52070463</p>

                    <div class="flex border-b border-gray-200 pb-4 mb-4">
                        <div class="w-1/2 pr-4 border-r border-gray-200">
                            <div class="text-sm text-gray-500 mb-1">Portföy</div>
                            <div class="text-lg font-bold" id="total-portfolio-value">0,00 TL</div>
                        </div>
                        <div class="w-1/2 pl-4">
                            <div class="text-sm text-gray-500 mb-1">Kâr/Zarar</div>
                            <div class="text-lg font-bold" id="total-profit-loss">+0,00 TL</div>
                        </div>
                    </div>

                    <div class="space-y-3 text-sm">
                        <div class="flex justify-between items-center">
                            <div class="flex items-center text-gray-700">
                                Borsa İşlem Limiti <i data-lucide="info" class="w-4 h-4 text-amber-500 ml-1"></i>
                            </div>
                            <div id="borsa-limit" class="font-semibold">0,00 TL</div>
                        </div>
                        <div class="flex justify-between items-center">
                            <div class="text-gray-700">T+2 Bakiyesi</div>
                            <div id="t2-bakiyesi" class="font-semibold">0,00 TL</div>
                        </div>

                        <div id="more-balances-container" class="space-y-3 hidden">
                            <div class="flex justify-between items-center border-t border-gray-100 pt-3">
                                <div class="text-gray-700">T+1 Bakiyesi</div>
                                <div id="t1-bakiyesi" class="font-semibold">0,00 TL</div>
                            </div>
                            <div class="flex justify-between items-center">
                                <div class="text-gray-700">TL Bakiyesi</div>
                                <div id="tl-bakiyesi" class="font-semibold">0,00 TL</div>
                            </div>
                            <div class="flex justify-between items-center">
                                <div class="text-gray-700">Bloke Bakiyesi</div>
                                <div id="bloke-bakiyesi" class="font-semibold">0,00 TL</div>
                            </div>
                        </div>
                    </div>

                    <div class="text-center mt-6">
                        <a href="#" id="toggle-balances-link" class="text-amber-500 font-medium text-sm">Daha Fazla Göster</a>
                    </div>
                </div>

                <!-- Hisse Kartları Konteyneri -->
                <div id="stock-cards-container" class="space-y-2">
                    <!-- Dinamik olarak dolacak -->
                </div>
                
                <!-- Hisse Güncelleme Formu -->
                <div id="form-container" class="bg-white shadow-md p-4 rounded-lg border-t-4 border-amber-500 hidden">
                    <h3 class="text-lg font-semibold mb-3 border-b pb-2">Hisse ve Hesap Verilerini Güncelle</h3>
                    <form id="update-form">
                        <div class="mb-3">
                            <label for="stock-select" class="detail-label block mb-1">Hisse Kodu Seçin / Yönetin</label>
                            <div class="flex space-x-2">
                                <select id="stock-select" class="flex-1 p-2 border border-gray-300 rounded-md focus:ring-amber-500">
                                    <!-- Dinamik dolacak -->
                                </select>
                                <button type="button" id="delete-btn" class="p-2 bg-red-50 text-red-500 border border-red-200 rounded-md hover:bg-red-100 transition">
                                    <i data-lucide="trash-2" class="w-5 h-5"></i>
                                </button>
                            </div>
                        </div>

                        <!-- Yeni Hisse Ekleme Alanı -->
                        <div class="mb-4 p-2 bg-gray-50 rounded-md border border-dashed border-gray-300">
                            <div class="flex space-x-2">
                                <input type="text" id="new-stock-code" placeholder="Yeni Hisse (Örn: THYAO.E)" class="flex-1 p-2 text-sm border border-gray-300 rounded-md uppercase">
                                <button type="button" id="add-btn" class="px-3 bg-green-600 text-white text-sm font-bold rounded-md hover:bg-green-700">EKLE</button>
                            </div>
                        </div>

                        <div class="mb-3">
                            <label for="input-quantity" class="detail-label block mb-1">Satılabilir Adet</label>
                            <input type="number" id="input-quantity" class="w-full p-2 border border-gray-300 rounded-md" step="0.01">
                        </div>
                        <div class="mb-3">
                            <label for="input-cost-price" class="detail-label block mb-1">Maliyet* (TL)</label>
                            <input type="number" id="input-cost-price" class="w-full p-2 border border-gray-300 rounded-md" step="0.01">
                        </div>
                        <div class="mb-3">
                            <label for="input-last-price" class="detail-label block mb-1">Son İşlem Fiyatı (TL)</label>
                            <input type="number" id="input-last-price" class="w-full p-2 border border-gray-300 rounded-md" step="0.01">
                        </div>
                        <div class="mb-3 border-t pt-3 mt-3">
                            <label for="input-borsa-limit" class="detail-label block mb-1 font-semibold text-gray-700">Borsa İşlem Limiti (TL)</label>
                            <input type="number" id="input-borsa-limit" class="w-full p-2 border border-gray-300 rounded-md" step="0.01">
                        </div>
                        <div class="mb-3">
                            <label for="input-t2-balance" class="detail-label block mb-1 font-semibold text-gray-700">T+2 Bakiyesi (TL)</label>
                            <input type="number" id="input-t2-balance" class="w-full p-2 border border-gray-300 rounded-md" step="0.01">
                        </div>
                        <div class="mb-3">
                            <label for="input-t1-balance" class="detail-label block mb-1 font-semibold text-gray-700">T+1 Bakiyesi (TL)</label>
                            <input type="number" id="input-t1-balance" class="w-full p-2 border border-gray-300 rounded-md" step="0.01">
                        </div>
                        <div class="mb-3">
                            <label for="input-tl-balance" class="detail-label block mb-1 font-semibold text-gray-700">TL Bakiyesi (TL)</label>
                            <input type="number" id="input-tl-balance" class="w-full p-2 border border-gray-300 rounded-md" step="0.01">
                        </div>
                        <div class="mb-5">
                            <label for="input-bloke-balance" class="detail-label block mb-1 font-semibold text-gray-700">Bloke Bakiyesi (TL)</label>
                            <input type="number" id="input-bloke-balance" class="w-full p-2 border border-gray-300 rounded-md" step="0.01">
                        </div>
                        <button type="submit" class="w-full bg-amber-500 text-white font-semibold py-2 rounded-md hover:bg-amber-600 transition">
                            Verileri Kaydet ve Güncelle
                        </button>
                        <div id="message-box" class="mt-3 p-2 text-sm text-center rounded-md hidden"></div>
                    </form>
                </div>
            </main>

            <!-- SEKME 2: EMİRLERİM -->
            <main id="tab-content-orders" class="tab-content p-2 space-y-4">
                <div class="px-1 mt-1">
                    <span class="text-[17px] text-gray-400 font-medium">İşlemin Yapılacağı Hesap</span>
                </div>
                
                <div class="bg-white p-4 rounded-lg shadow-sm flex justify-between items-start">
                    <div class="flex flex-col space-y-1">
                        <div class="flex items-center space-x-1">
                            <span class="text-[17px] font-bold text-gray-800">Yatırım Hesab...</span>
                            <span class="text-[17px] text-gray-400 font-medium">Yatırım TL</span>
                        </div>
                        <span class="text-[17px] text-gray-400 font-medium">52270463</span>
                        <span class="text-[16px] text-gray-400 font-medium">Borsa İşlem Limiti</span>
                    </div>
                    <div class="text-right flex flex-col justify-end h-full pt-10">
                        <span id="order-borsa-limit" class="text-[22px] font-bold text-gray-800">0,00 TL</span>
                    </div>
                </div>

                <div class="outer-white-box">
                    <div class="date-range-outline">
                        <span class="date-range-label">Tarih Aralığı</span>
                        <div class="flex items-center justify-between">
                            <span class="text-[17px] text-gray-800 font-medium">Bugün</span>
                            <i data-lucide="calendar" class="w-5 h-5 text-gray-400"></i>
                        </div>
                    </div>
                </div>

                <div id="search-trigger" class="flex items-center space-x-2 px-2 pt-2 cursor-pointer group">
                    <i data-lucide="search" class="w-5 h-5 text-[#fcae01]"></i>
                    <span class="text-[17px] text-[#fcae01] font-medium group-active:opacity-70">Detaylı Ara</span>
                </div>

                <div id="orders-empty-state" class="bg-white p-4 rounded-lg shadow-sm">
                    <div class="flex flex-col items-center justify-center py-10">
                        <div class="p-4 rounded-full mb-4 strike-container">
                            <i data-lucide="file-text" class="w-16 h-16 text-gray-800"></i>
                            <span class="strike-line2"></span>
                            <span class="strike-line"></span>
                        </div>
                        <p class="text-[17px] text-gray-800 font-medium">Bugüne ait emriniz bulunmamaktadır.</p>
                    </div>
                </div>

                <div id="orders-list-state" class="hidden space-y-4 pb-10">
                    <div class="bg-white p-4 rounded-lg shadow-sm space-y-3">
                        <div class="flex justify-between items-center">
                            <span class="text-[17px] text-gray-400 font-medium">Gerçekleşen Toplam Tutar</span>
                            <span id="order-summary-done" class="text-[17px] text-gray-800 font-medium">0,00 TL</span>
                        </div>
                        <div class="flex justify-between items-center">
                            <span class="text-[17px] text-gray-400 font-medium">Bekleyen Toplam Tutar</span>
                            <span id="order-summary-wait" class="text-[17px] text-gray-800 font-medium">0,00 TL</span>
                        </div>
                        <div class="flex justify-between items-center">
                            <span class="text-[17px] text-gray-400 font-medium">İptal Edilen Toplam Tutar</span>
                            <span id="order-summary-cancel" class="text-[17px] text-gray-800 font-medium">0,00 TL</span>
                        </div>
                    </div>

                    <div id="dynamic-order-card" class="bg-white p-4 rounded-lg shadow-sm space-y-3"></div>

                    <!-- Emir Detay Edit Formu (Logoya basınca gizlenmesi istenen form) -->
                    <div id="order-detail-edit-form" class="bg-white p-4 rounded-lg shadow-md border-t-2 border-gray-800 space-y-4 hidden">
                        <h3 class="text-sm font-bold text-gray-800 uppercase flex items-center">
                            <i data-lucide="edit-3" class="w-4 h-4 mr-2"></i> Detaylı Veri Güncelleme
                        </h3>
                        <div class="space-y-2 border-b pb-3">
                            <p class="text-[11px] font-bold text-gray-400">ÖZET TUTARLAR (1. KUTU)</p>
                            <input type="text" id="edit-summary-done" placeholder="Gerçekleşen Toplam" class="w-full p-2 border border-gray-200 rounded text-sm">
                            <input type="text" id="edit-summary-wait" placeholder="Bekleyen Toplam" class="w-full p-2 border border-gray-200 rounded text-sm">
                            <input type="text" id="edit-summary-cancel" placeholder="İptal Edilen Toplam" class="w-full p-2 border border-gray-200 rounded text-sm">
                        </div>
                        <div class="space-y-2">
                            <p class="text-[11px] font-bold text-gray-400 flex justify-between items-center">
                                <span>EMİR DETAYLARI (2. KUTU)</span>
                                <span id="label-box2-total" class="text-[10px] text-gray-500 font-bold ml-2"></span>
                            </p>
                            <input type="text" id="edit-order-symbol" value="BMSTL.E" class="w-full p-2 border border-gray-200 rounded text-sm font-bold">
                            <input type="text" id="edit-order-qty" value="1" class="w-full p-2 border border-gray-200 rounded text-sm">
                            <input type="text" id="edit-order-price" value="86,05" class="w-full p-2 border border-gray-200 rounded text-sm">
                            <input type="text" id="edit-order-status" value="Borsaya İletilecek" class="w-full p-2 border border-gray-200 rounded text-sm">
                        </div>
                        <button onclick="updateOrderDetailFields()" class="w-full bg-gray-800 text-white font-bold py-2 rounded text-sm hover:bg-black transition">
                            DEĞİŞİKLİKLERİ UYGULA
                        </button>
                    </div>
                </div>
            </main>
        </div>
    </div>

    <script type="module">
        let stocks = {}; 
        let accountDetails = {}; 
        let isDetailsVisible = false;

        let orderDetailState = {
            summary: { done: '0,00 TL', wait: '0,00 TL', cancel: '0,00 TL' },
            card: { symbol: 'BMSTL.E', qty: '1', price: '86,05 TL', status: 'Borsaya İletilecek' }
        };

        const STOCK_KEY = 'portfolioStocks_v4';
        const ACCOUNT_DETAILS_KEY = 'portfolioAccountDetails_v4'; 
        const ORDER_DETAIL_KEY = 'orderDetailState_v2';
        const IMAGE_URLS = ["https://i.imgur.com/LIvAA9i.png", "https://i.imgur.com/o8d9pDs.png", "https://i.imgur.com/SD90fP5.png"];

        const defaultStocks = { 
            'BMSTL.E': { quantity: 1186.00, costPrice: 26.37, lastPrice: 82.90 }, 
            'HKTM.E': { quantity: 500.00, costPrice: 45.00, lastPrice: 42.10 } 
        };
        const defaultAccountDetails = { borsaLimit: 50000, t2Balance: 0, t1Balance: 0, tlBalance: 0, blokeBalance: 0 };

        const stockSelect = document.getElementById('stock-select');
        const cardsContainer = document.getElementById('stock-cards-container');
        const inputQuantity = document.getElementById('input-quantity');
        const inputCostPrice = document.getElementById('input-cost-price');
        const inputLastPrice = document.getElementById('input-last-price');
        const inputBorsaLimit = document.getElementById('input-borsa-limit'); 
        const inputT2Balance = document.getElementById('input-t2-balance');
        const inputT1Balance = document.getElementById('input-t1-balance');
        const inputTlBalance = document.getElementById('input-tl-balance');
        const inputBlokeBalance = document.getElementById('input-bloke-balance');
        const toggleLink = document.getElementById('toggle-balances-link'); 
        const moreBalancesContainer = document.getElementById('more-balances-container'); 
        const updateForm = document.getElementById('update-form');
        const messageBox = document.getElementById('message-box');
        const statusIcon = document.getElementById('status-icon');
        const formContainer = document.getElementById('form-container');
        const orderEditForm = document.getElementById('order-detail-edit-form');

        const searchTrigger = document.getElementById('search-trigger');
        const ordersEmpty = document.getElementById('orders-empty-state');
        const ordersList = document.getElementById('orders-list-state');
        const dynamicOrderCard = document.getElementById('dynamic-order-card');

        // Form Görünürlüğünü Kontrol Eden Fonksiyon (Her iki form için)
        window.toggleUpdateForm = function() {
            // Portföy sayfasındaki form
            if (formContainer) {
                formContainer.classList.toggle('hidden');
            }
            // Emirler sayfasındaki form
            if (orderEditForm) {
                orderEditForm.classList.toggle('hidden');
            }
            
            // Eğer açıldıysa en alta kaydır
            if (formContainer && !formContainer.classList.contains('hidden')) {
                formContainer.scrollIntoView({ behavior: 'smooth' });
            }
        };

        // FORMATTERS
        function formatCurrencyInput(val) {
            if (!val) return "0,00 TL";
            let cleanVal = val.toString().replace(',', '.').replace(/[^\d.]/g, '');
            let floatVal = parseFloat(cleanVal);
            if (isNaN(floatVal)) return "0,00 TL";
            return floatVal.toLocaleString('tr-TR', { minimumFractionDigits: 2, maximumFractionDigits: 2 }) + ' TL';
        }

        function formatQuantityInput(val) {
            if (!val) return "0";
            let cleanVal = val.toString().replace(',', '.').replace(/[^\d.]/g, '');
            let floatVal = parseFloat(cleanVal);
            if (isNaN(floatVal)) return val;
            return floatVal.toLocaleString('tr-TR');
        }

        // EMİR YÖNETİMİ
        searchTrigger.addEventListener('click', () => {
            isDetailsVisible = !isDetailsVisible;
            if (isDetailsVisible) {
                ordersEmpty.classList.add('hidden');
                ordersList.classList.remove('hidden');
                renderSingleOrder();
            } else {
                ordersEmpty.classList.remove('hidden');
                ordersList.classList.add('hidden');
            }
        });

        window.updateOrderDetailFields = function() {
            const doneVal = document.getElementById('edit-summary-done').value;
            const waitVal = document.getElementById('edit-summary-wait').value;
            const cancelVal = document.getElementById('edit-summary-cancel').value;
            if (doneVal) orderDetailState.summary.done = formatCurrencyInput(doneVal);
            if (waitVal) orderDetailState.summary.wait = formatCurrencyInput(waitVal);
            if (cancelVal) orderDetailState.summary.cancel = formatCurrencyInput(cancelVal);
            orderDetailState.card.symbol = document.getElementById('edit-order-symbol').value || orderDetailState.card.symbol;
            const qtyInput = document.getElementById('edit-order-qty').value;
            if (qtyInput) orderDetailState.card.qty = formatQuantityInput(qtyInput);
            const priceVal = document.getElementById('edit-order-price').value;
            if (priceVal) orderDetailState.card.price = formatCurrencyInput(priceVal);
            orderDetailState.card.status = document.getElementById('edit-order-status').value || orderDetailState.card.status;
            localStorage.setItem(ORDER_DETAIL_KEY, JSON.stringify(orderDetailState));
            renderSingleOrder();
        };

        function renderSingleOrder() {
            document.getElementById('order-summary-done').innerText = orderDetailState.summary.done;
            document.getElementById('order-summary-wait').innerText = orderDetailState.summary.wait;
            document.getElementById('order-summary-cancel').innerText = orderDetailState.summary.cancel;
            let rawQty = orderDetailState.card.qty.replace(/[^\d,.]/g, '').replace(',', '.');
            let rawPrice = orderDetailState.card.price.replace(/[^\d,.]/g, '').replace(',', '.');
            let totalRow = (parseFloat(rawQty) || 0) * (parseFloat(rawPrice) || 0);
            let formattedRowTotal = totalRow.toLocaleString('tr-TR', { minimumFractionDigits: 2, maximumFractionDigits: 2 }) + ' TL';
            const box2LabelTotal = document.getElementById('label-box2-total');
            if(box2LabelTotal) box2LabelTotal.innerText = `[${formattedRowTotal}]`;
            dynamicOrderCard.innerHTML = `
                <div class="flex justify-between items-center border-b border-gray-100 pb-2 mb-2">
                    <span class="font-bold text-lg text-gray-800">${orderDetailState.card.symbol}</span>
                    <i data-lucide="chevron-right" class="w-6 h-6 text-gray-300"></i>
                </div>
                <div class="space-y-3">
                    <div class="flex justify-between items-center">
                        <span class="text-[17px] text-gray-400 font-medium">Emir/Gerçekleşen Adet</span>
                        <span class="text-[17px] text-gray-600 font-medium">${orderDetailState.card.qty}</span>
                    </div>
                    <div class="flex justify-between items-center">
                        <span class="text-[17px] text-gray-400 font-medium">Emir Fiyat</span>
                        <span class="text-[17px] text-gray-600 font-medium">${orderDetailState.card.price}</span>
                    </div>
                    <div class="flex justify-between items-center">
                        <span class="text-[17px] text-gray-400 font-medium">Emir Durumu</span>
                        <span class="text-[17px] text-gray-900 font-medium">${orderDetailState.card.status}</span>
                    </div>
                </div>
            `;
            lucide.createIcons();
        }

        // PORTFÖY DİNAMİK YÖNETİM
        function addNewStock() {
            const input = document.getElementById('new-stock-code');
            const code = input.value.trim().toUpperCase();
            if (!code) return showMessage("Hisse kodu girin.", "bg-red-100 text-red-800");
            if (stocks[code]) return showMessage("Hisse zaten mevcut.", "bg-amber-100 text-amber-800");
            
            stocks[code] = { quantity: 0, costPrice: 0, lastPrice: 0 };
            localStorage.setItem(STOCK_KEY, JSON.stringify(stocks));
            input.value = '';
            renderStockOptions();
            stockSelect.value = code;
            fillFormFields();
            updatePortfolioView();
            showMessage("Hisse eklendi.", "bg-green-100 text-green-800");
        }

        function deleteSelectedStock() {
            const code = stockSelect.value;
            if (!code) return;
            if (confirm(`${code} hissesini silmek istediğinizden emin misiniz?`)) {
                delete stocks[code];
                localStorage.setItem(STOCK_KEY, JSON.stringify(stocks));
                renderStockOptions();
                updatePortfolioView();
                fillFormFields();
                showMessage("Hisse silindi.", "bg-gray-100 text-gray-800");
            }
        }

        window.addNewStock = addNewStock;
        window.deleteSelectedStock = deleteSelectedStock;

        document.getElementById('add-btn').onclick = addNewStock;
        document.getElementById('delete-btn').onclick = deleteSelectedStock;

        function renderStockOptions() {
            const currentVal = stockSelect.value;
            stockSelect.innerHTML = '';
            const sortedCodes = Object.keys(stocks).sort();
            sortedCodes.forEach(code => {
                const opt = document.createElement('option');
                opt.value = code;
                opt.textContent = code;
                stockSelect.appendChild(opt);
            });
            if (stocks[currentVal]) stockSelect.value = currentVal;
            else if (sortedCodes.length > 0) stockSelect.value = sortedCodes[0];
        }

        // GENEL UI
        window.switchTab = function(tab) {
            const btnP = document.getElementById('tab-btn-portfolio');
            const btnO = document.getElementById('tab-btn-orders');
            const contentP = document.getElementById('tab-content-portfolio');
            const contentO = document.getElementById('tab-content-orders');
            if (tab === 'portfolio') {
                btnP.className = "tab-button p-3 text-center w-1/2 text-black border-b-2 border-amber-500 font-bold";
                btnO.className = "tab-button p-3 text-center w-1/2 hover:text-gray-700";
                contentP.classList.add('active'); contentO.classList.remove('active');
            } else {
                btnO.className = "tab-button p-3 text-center w-1/2 text-black border-b-2 border-amber-500 font-bold";
                btnP.className = "tab-button p-3 text-center w-1/2 hover:text-gray-700";
                contentO.classList.add('active'); contentP.classList.remove('active');
            }
            lucide.createIcons();
        };

        function updateTime() {
            const el = document.getElementById('current-time');
            if (el) el.textContent = new Date().toLocaleTimeString('tr-TR', { hour: '2-digit', minute: '2-digit' });
        }
        setInterval(updateTime, 1000);

        function loadData() {
            const storedStocks = localStorage.getItem(STOCK_KEY);
            stocks = storedStocks ? JSON.parse(storedStocks) : defaultStocks;
            const storedAcc = localStorage.getItem(ACCOUNT_DETAILS_KEY);
            accountDetails = storedAcc ? JSON.parse(storedAcc) : defaultAccountDetails;
            const storedOrders = localStorage.getItem(ORDER_DETAIL_KEY);
            if (storedOrders) orderDetailState = JSON.parse(storedOrders);
            renderStockOptions();
            fillFormFields();
        }

        function fillFormFields() {
            const s = stocks[stockSelect.value];
            if (s) {
                inputQuantity.value = s.quantity;
                inputCostPrice.value = s.costPrice;
                inputLastPrice.value = s.lastPrice;
            } else {
                inputQuantity.value = ''; inputCostPrice.value = ''; inputLastPrice.value = '';
            }
            inputBorsaLimit.value = accountDetails.borsaLimit;
            inputT2Balance.value = accountDetails.t2Balance;
            inputT1Balance.value = accountDetails.t1Balance;
            inputTlBalance.value = accountDetails.tlBalance;
            inputBlokeBalance.value = accountDetails.blokeBalance;
        }

        function updatePortfolioView() {
            cardsContainer.innerHTML = '';
            let totalVal = 0;
            let totalPL = 0;
            const format = (v) => (v || 0).toLocaleString('tr-TR', { minimumFractionDigits: 2, maximumFractionDigits: 2 }) + ' TL';

            Object.entries(stocks).forEach(([code, s]) => {
                const currentVal = s.quantity * s.lastPrice;
                const cost = s.quantity * s.costPrice;
                const plAmount = currentVal - cost;
                totalVal += currentVal;
                totalPL += plAmount;
            });

            document.getElementById('total-portfolio-value').textContent = format(totalVal);
            const plEl = document.getElementById('total-profit-loss');
            plEl.textContent = (totalPL >= 0 ? '+' : '') + format(totalPL);
            plEl.className = `text-lg font-bold ${totalPL >= 0 ? 'text-green-600' : 'text-red-600'}`;
            document.getElementById('borsa-limit').textContent = format(accountDetails.borsaLimit);
            document.getElementById('t2-bakiyesi').textContent = format(accountDetails.t2Balance);
            document.getElementById('order-borsa-limit').textContent = format(accountDetails.borsaLimit);

            Object.entries(stocks).forEach(([code, s]) => {
                const currentVal = s.quantity * s.lastPrice;
                const cost = s.quantity * s.costPrice;
                const plAmount = currentVal - cost;
                const plPer = cost > 0 ? (plAmount / cost) * 100 : 0;
                const portPer = totalVal > 0 ? (currentVal / totalVal) * 100 : 0;
                const sProfit = plAmount >= 0;

                const card = document.createElement('div');
                card.id = `card-${code}`;
                card.className = "bg-white p-4 rounded-lg shadow-sm";
                card.innerHTML = `
                    <div class="flex justify-between items-center mb-2">
                        <h2 class="text-lg font-bold">${code}</h2>
                        <div class="flex items-center space-x-2">
                            <span class="text-xl font-bold">${format(currentVal)}</span>
                            <i data-lucide="chevron-right" class="w-5 h-5 text-gray-400"></i>
                        </div>
                    </div>
                    <div class="flex justify-between items-end mb-2">
                        <span class="text-gray-600 text-xs font-medium">%${portPer.toFixed(2)}</span>
                        <div class="text-right">
                            <div class="text-sm font-semibold flex items-center ${sProfit ? 'text-green-600' : 'text-red-600'}">
                                <i data-lucide="triangle" class="w-3 h-3 mr-1 ${sProfit ? '' : 'rotate-180'}"></i>
                                <span>%${sProfit ? '+' : ''}${plPer.toFixed(2).replace('.', ',')}</span>
                                <span class="text-xs font-normal ml-1">(${sProfit ? '+' : ''}${plAmount.toLocaleString('tr-TR')} TL)</span>
                            </div>
                        </div>
                    </div>
                    <div class="w-full h-2 bg-gray-200 rounded-full mb-3">
                        <div class="h-2 light-blue-bar rounded-full" style="width: ${portPer}%;"></div>
                    </div>
                    <div class="grid grid-cols-3 gap-2 text-sm">
                        <div><div class="detail-label">Satılabilir Adet</div><div class="font-medium">${s.quantity.toLocaleString('tr-TR')}</div></div>
                        <div><div class="detail-label">Maliyet*</div><div class="font-medium">${s.costPrice.toFixed(2).replace('.', ',')} TL</div></div>
                        <div><div class="detail-label">Son İşlem Fiyatı</div><div class="font-medium">${s.lastPrice.toFixed(2).replace('.', ',')} TL</div></div>
                    </div>
                `;
                cardsContainer.appendChild(card);
            });
            lucide.createIcons();
        }

        updateForm.onsubmit = (e) => {
            e.preventDefault();
            const code = stockSelect.value;
            if(!code) return;
            stocks[code] = {
                quantity: parseFloat(inputQuantity.value) || 0,
                costPrice: parseFloat(inputCostPrice.value) || 0,
                lastPrice: parseFloat(inputLastPrice.value) || 0
            };
            accountDetails = {
                borsaLimit: parseFloat(inputBorsaLimit.value) || 0,
                t2Balance: parseFloat(inputT2Balance.value) || 0,
                t1Balance: parseFloat(inputT1Balance.value) || 0,
                tlBalance: parseFloat(inputTlBalance.value) || 0,
                blokeBalance: parseFloat(inputBlokeBalance.value) || 0
            };
            localStorage.setItem(STOCK_KEY, JSON.stringify(stocks));
            localStorage.setItem(ACCOUNT_DETAILS_KEY, JSON.stringify(accountDetails));
            updatePortfolioView();
            showMessage("Veriler başarıyla güncellendi.", 'bg-green-100 text-green-800');
        };

        function showMessage(message, classes) {
            messageBox.textContent = message;
            messageBox.className = `mt-3 p-2 text-sm text-center rounded-md ${classes}`;
            messageBox.classList.remove('hidden');
            setTimeout(() => messageBox.classList.add('hidden'), 3000);
        }

        stockSelect.onchange = fillFormFields;
        toggleLink.onclick = (e) => {
            e.preventDefault();
            const isHidden = moreBalancesContainer.classList.toggle('hidden');
            toggleLink.textContent = isHidden ? 'Daha Fazla Göster' : 'Daha Az Göster';
        };

        window.onload = () => {
            updateTime();
            loadData();
            updatePortfolioView();
            const randomIndex = Math.floor(Math.random() * IMAGE_URLS.length);
            statusIcon.src = IMAGE_URLS[randomIndex];
            lucide.createIcons();
        };
    </script>
</body>
</html>
